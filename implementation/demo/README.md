# End-to-End Hacky Test With Single Signer

This document describes steps required to run the test.

Prepare 4 terminal windows in which you will run each section.

## Set Up

### Ganache

Execute command to run Ganache:
```sh
ganache-cli
```

### Bitcoin SPV

1. Clone [bitcoin-spv](https://github.com/summa-tx/bitcoin-spv) repository
   ```sh
   git clone https://github.com/summa-tx/bitcoin-spv.git
   ```
   
2. Configure environment variable with a path to the cloned repository, e.g.:
    ```sh
    export BITCOIN_SPV_DIR="/Users/jakub/workspace/bitcoin-spv/"
    ```

3. Install python 3.6.6:
    ```sh
    brew install pyenv
    pyenv install 3.6.6
    ```

4. Set up python environment:
    ```sh
    brew install pipenv
    cd $BITCOIN_SPV_DIR && pipenv install --python ~/.pyenv/versions/3.6.6/bin/python
    ```

5. Compile contracts
   ```sh
   cd $BITCOIN_SPV_DIR
   npm install
   npm run compile
   ```
   Requires `node` version 12.3.1 or greater. To install latest node version run
   `npm install -g node`

6. Update [host details] in `merkle.py` script to point to a server running on 
   TestNet.

   Example config:
   ```python
    "hostname": "testnet1.bauerj.eu",
   ```
   If server above is not working use the [list] to find alternative one.
   
   [host details]:https://github.com/summa-tx/bitcoin-spv/blob/master/scripts/merkle.py#L44-L49
   [list]:https://1209k.com/bitcoin-eye/ele.php?chain=tbtc

### Keep tECDSA

**Repository**: [keep-network/keep-tecdsa](https://github.com/keep-network/keep-tecdsa)

#### Prepare

1. [Deploy contracts](https://github.com/keep-network/keep-tecdsa/tree/master/solidity#deploy-contracts).
   Note down `KeepRegistry` contract's address, you will need it later.
   
2. [Configure and build](https://github.com/keep-network/keep-tecdsa#keep-tecdsa) 
   the client.
   
#### Run

Run keep client:
```sh
./keep-tecdsa start
```
You should see `Client started.` output message.

### tBTC

**Repository**: [keep-network/tbtc](https://github.com/keep-network/tbtc)

#### Prepare

1. Run setup:
    ```sh
    cd implementation && npm run setup
    ```

2. Provide `KeepRegistry` contract address (copied from Keep tECDSA) in 
  [migrations/2_deploy_contracts.js](../migrations/2_deploy_contracts.js):
   ```js
   const KeepRegistryAddress = '0x224ee0E3dD53fED55d678cc649598D8d797c80B2' // KeepRegistry contract address
   ```

3. Deploy contracts:
    ```sh
    truffle migrate -â€”reset
    ```
    Note down `TBTCSystem` contract's address, you will need it later.
   

### tBTC Maintainer

**Repository**: [keep-network/tbtc-maintainers](https://github.com/keep-network/tbtc-maintainers)

**Prerequisite**: tBTC Maintainer can be started only after deploying 
`TBTCSystem` contract for `tBTC`.

#### Prepare

Configure and build the client according to [instructions](https://github.com/keep-network/tbtc-maintainers#tbtc-maintainers). 
You will need `TBTCSystem` contract address.

#### Run

Start difficulty monitor
```sh
./tbtc-maintainer start
```

### Transaction

In the middle of the test you will need to submit a funding transaction to the
account generated by a keep. It has to be a SegWit transaction.

Transaction can be submitted in multiple ways. Two easiest solutions are:
- use Bitcoin wallet working on TestNet supporting SegWit transactions (e.g. 
  [Electrum] or [GreenAddress]),
- use a [tool] to create a raw transaction and broadcast it.

To obtain initial funds on you Bitcoin TestNet account which you will use as a 
source for the transaction use one of available faucets (e.g. [Coin Faucet]).

*Note*: To start [Electrum] wallet in a TestNet mode run:
```sh
open -n /Applications/Electrum.app --args --testnet
```

[Electrum]:https://electrum.org
[GreenAddress]:https://test.greenaddress.it/
[tool]:https://github.com/nkuba/btc-tools
[Coin Faucet]:https://coinfaucet.eu/en/btc-testnet/

## Run test

### Quick way

```sh
./run.sh
```

### Step by step way

1. Execute the `1_create_new_deposit.js` script with truffle. This will output a
   new deposit address (`new deposit deployed`) - use it in next steps.
   ```sh
   truffle exec demo/1_create_new_deposit.js
   ```

2. Execute `2_fetch_public_key.js` script with truffle. Provide deposit address
   created in step 1. as an argument.
   ```sh
   truffle exec demo/2_fetch_public_key.js <DEPOSIT_ADDRESS>
   ```

3. Send a funding bitcoin witness transaction to the address generated by the keep.
   
4. Execute `3_provide_funding_proof.js` script with truffle. Provide following
   arguments:
   - DEPOSIT_ADDRESS - deposit created in step 1 (e.g. `0xA2E639DB88C103A028a4B8073c5559Ab97c72862`)
   - TX_ID - funding transaction ID (e.g. `4e3388fad9732d3c099fa95a98c9d2dd062e4a8cf7ad03f647eaccc478a79068`)
   - HEADERS_COUNT - number of headers required for the proof (e.g. `6`):
 - 
   ```sh
   truffle exec demo/3_provide_funding_proof.js <DEPOSIT_ADDRESS> <TX_ID> <HEADERS_COUNT>
   ```


## Expected results
After setting everything up and running the test scripts you should see following 
results:

- From `tbtc-maintainer` client:
    ```
    Connected to Electrum Server.
    Server version: ElectrumX 1.12 [Protocol 1.4]
    2019/06/26 16:20:39 Current block height: [1565431], difficulty: [1994845]
    Transaction submitted with hash: bb14277d128b22c6cf0cdb95961dc69b836bc13493f6f532dc8a465adb62b99e
    ```

- From running `1_create_new_deposit.js` script:
    ```
    Using network 'development'.
    new deposit deployed:  0xA2E639DB88C103A028a4B8073c5559Ab97c72862
    createNewDeposit transaction:  0x0997970c596eacafaaf88682ae22e76bee01103cc513e5784d7d53ade3908a39
    ```

- From `keep-tecdsa` client:
    ```
    Client started.
    New ECDSA Keep created [&{KeepAddress:[116 205 237 170 116 80 21 161 197 216 70 64 166 124 131 219 80 158 13 224]}]
    Transaction submitted with hash: 9de59b0266146e18199c6ed1de3e15854eec597c422ebd8c0f8330c68c905546
    Signer for keep [0x74cDEdAA745015a1c5D84640a67c83DB509E0de0] initialized with Bitcoin P2WPKH address [tb1qmpymrcwwmc4v04cc3nu8qr5h66t4eywyqz20fl]
    ```

- From running `2_fetch_public_key.js` script:
    ```
    Using network 'development'.
    Call getPublicKey
    retrieveSignerPubkey transaction:  0xce753f4d5c67c67c871b4b4242116285eecb9860e0608ee9d50c1a28557b12f0
    Registered public key:
    X: 0x8896955d043b5a43957b21901f2cce9f0bfb484531b03ad6cd3153e45e73ee2e
    Y: 0xf687f923b5896a409cb7e2b5ae456f61ac61862305c6ec86bd7421b5bce115e0
    ```

- From running `3_provide_funding_proof.js` script:
    ```
    Using network 'development'.
    Get transaction proof...
    Transaction ID: 4e3388fad9732d3c099fa95a98c9d2dd062e4a8cf7ad03f647eaccc478a79068
    Get bitcoin-spv proof...
    Received data from bitcoin-spv
    Parse bitcoin-spv output...
    Parse transaction...
    TX: 010000000001010d994e29bc2de692152f70ba41a696bb49060d0719d568f8ded1bc45f92f14690000000000ffffffff029001000000000000160014d849b1e1cede2ac7d7188cf8700e97d6975c91c464000000000000001976a914d849b1e1cede2ac7d7188cf8700e97d6975c91c488ac0247304402206b41d2379bfab9fe1af9155d61596009980dc64d09fffe2893de0f4288f9b6f202200b0fbe2bc8e235da25e6c3a564c972e635bf59af80275ead7e9c3eb39097acc90121028896955d043b5a43957b21901f2cce9f0bfb484531b03ad6cd3153e45e73ee2e00000000
    witness is not fully supported
    witness is not fully supported
    witness is not fully supported
    Funding Proof: {
        merkleProof: '6890a778c4ccea47f603adf78c4a2e06ddd2c9985aa99f093c2d73d9fa88334e2b151fb4da5ce7111979d4b5f7a0ea558ca96ddd16776aa6dc405c2871698c8c51d9491c66a2294b2243cf094214918e2f3aff8d43a60a3b68a4a41b290b641751119c311cfdf432ff4136c2c58d78146451a4f6b26128faa3d7249377c1cc1b85ae0dc93e9e27273578482536f46aa43f2397eb7fe6d63098f241bc15680d61ab95d7ffd57584b07dbb6d8f63337f2c28e7ae9b056b650dacab7cd7aac50f5ea889944c8ebecd075a3e23e8a4072c459c0743e40989785415ebdeae1ec5d5bdfbd41321329355240e8952663c1e62bcb0495727456c8337d22062805b4026aa',
        txInBlockIndex: '19',
        chainHeaders: '0000002049b5aad025900af71c98997fc3bdcb6a90714a0ff89ab78a4702000000000000fbd41321329355240e8952663c1e62bcb0495727456c8337d22062805b4026aa3ba0125d0069081a51fe5af300000020ede8125f76d513d62166e9e69b91082e0f2a33c6f4b4b2466b0400000000000018ed2a34a57f29964aa7cb38272b779be231b11e49c3038c962c4979083bd9bc8ea0125d0069081a92b937a100000020aaaecb86765a1fdd62097353a5e62eea3465e519e6b98aa7500800000000000052cc9be921eee739bcd4dc50daf28aac24825636592f84b73805ca317c928bc1baa0125d0069081aa1fc0bb700e0ff3f5e5c529c9037be0a22c227fbf50968f8abdbbd5b1b90a0764704000000000000e3b6d3ff1a770cdc08d6fec6b5eda02d884b5bb2109df31b98d868cfaaecbf4d5da3125d0069081a998b288e00000020fed717cc8b1c381563607c06de388d22d22c6c55af0dcca04402000000000000c116b39e7450772606fe863d18b7a8be4766d343289de21c6db8f9658a9cf43541a3125d0069081af28b6b61000000208aab7e92ffe2ad89fb5aca9fabbf15f2f833e195ac2958e61a06000000000000e1d8bb3b8a6b6a693f974475a3e2fc1cba6639c3f14a0dbe6788833d374f0489aaa3125d0069081a006a5b4d00000020937950750903d95593cb89d9b21be7562afdc00bf58e96b89c0400000000000032156347229ba3d5e6e0d84d8f4cbcac4d54bd2bb54dd4aaab91cfe986cea19a16a4125d0069081a7a64ad5c',
        version: '01000000',
        txInVector: '010d994e29bc2de692152f70ba41a696bb49060d0719d568f8ded1bc45f92f14690000000000ffffffff',
        txOutVector: '029001000000000000160014d849b1e1cede2ac7d7188cf8700e97d6975c91c464000000000000001976a914d849b1e1cede2ac7d7188cf8700e97d6975c91c488ac',
        locktime: '00000000'
    }
    Submit funding proof...
    child process exited with code 0
    provideBTCFundingProof transaction:  0xe320afd83641b34d18c3137da979c49c208fa98c2859666f382aa5dfa4663879
    Funding proof accepted for the deposit:  0xED0Ac208B1BF02Ab05563236b20F141b8498371A
    ```
